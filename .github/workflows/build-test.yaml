name: CI
on: [ push ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: clone
        uses: actions/checkout@v1
      - name: install dependencies
        run: sudo apt-get -y install g++-12 build-essential cmake ninja-build libgtest-dev
      - name: add build folder
        run: mkdir -p build
      - name: build
        working-directory: ./build
        run: cmake -Wno-dev -DCMAKE_C_COMPILER=gcc-12 -DCMAKE_CXX_COMPILER=g++-12 -DCMAKE_BUILD_TYPE=Release -DSTONKS_ENABLE_TESTS=ON -DSTONKS_RUN_ON_CI=ON -DSTONKS_SANITIZE=ON -DSTONKS_UBSan=ON -G "Ninja" -S .. -B . && cmake --build . -j4
      - name: tests
        working-directory: ./build
        run: ctest
      - uses: ZedThree/clang-tidy-review@v0.14.0
        id: review

      # Uploads an artefact containing clang_fixes.json
      - uses: ZedThree/clang-tidy-review/upload@v0.14.0
        id: upload-review

      # If there are any comments, fail the check
      - if: steps.review.outputs.total_comments > 0
        run: exit 1